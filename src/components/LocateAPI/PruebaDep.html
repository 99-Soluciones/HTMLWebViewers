<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script
      type="module"
      src="https://ajax.googleapis.com/ajax/libs/@googlemaps/extended-component-library/0.6.11/index.min.js"
    ></script>
    <!-- Esto solo es para pruebas, en Filemaker se seguira usando Style -->
    <!-- <link rel='stylesheet' href='../css/index.css'> -->
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: -apple-system, system-ui, sans-serif;
      }
      gmpx-place-picker {
        --gmpx-color-primary: #0071ea93;
        --gmpx-color-surface: #ffffff;
        --gmpx-color-on-surface: #808080;
        --gmpx-font-family-base: "Poppins", "Segoe UI", system-ui, sans-serif;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        width: 300px;
        margin: 8px auto;
      }
      gmp-map {
        height: calc(100% - 0px);
      }
    </style>
    <!-- Reealizar preubas con JS -->
    <!-- <script type='module' src='../../../utils/js/execFileMaker.js'></script> <script type='module' src='../../../utils/js/LocateAPI/addressUtils.js'></script> <script type='module' src='../../../utils/js/LocateAPI/formatComments.js'></script> <script type='module' src='../../../utils/js/LocateAPI/formatTittle.js'></script> <script type='module' src='../js/index.js'></script> -->
    <!-- Esto solo es para pruebas, en Filemaker se seguira usando JS -->
    <script>
      /*
       * Imports (descomenta si vas a usar <script type="module"> o mueve estas líneas a un archivo .js y cárgalo como módulo)
       * import { execFileMaker } from '../../../utils/js/execFileMaker.js';
       * import { formatComments } from '../../../utils/js/LocateAPI/formatComments.js';
       * import { getComponent, getDelegacion, buildAddressLine } from '../../../utils/js/LocateAPI/addressUtils.js';
       * import { formatTitleWithWrap } from '../../../utils/js/LocateAPI/formatTittle.js';
       */
      /* --- Data --- */
      let coordinates = { lat: "", lng: "" };
      let datos = {
        placeDisplayName: `Fiebre de Malta` || '',
        direccion1: `Rio lerma 156 local 1` || '',
        colonia: `Polanco` || '',
        delegacion: `cuahutemoc` || '',
        cp: `6500` || '',
        ciudad: `CDMX` || '',
        estado: `CDMX` || '',
        pais: `` || '',
      };
      /* --- Data example tests--- */
      /* let coordinates = { 'lat': 19.4326, 'lng': -99.1332 }; // Default to Mexico City if not provided
      let datos = { placeDisplayName: 'Nombre del lugar' || '', direccion1: 'Nombre de la calle 123', colonia: 'Colonia Centro', delegacion: 'Cuauhtémoc', cp: '06000', ciudad: 'Ciudad de México', estado: 'CDMX', pais: 'México', }; */
      /*--- Functions --- */
      /*--- execFileMaker.js---*/
      /**
       * Execute FileMaker Script
       * @param {object} data - Data (JSON) to use in FileMaker Script
       * @param {string} scriptName - Name of the script from FileMaker
       */
      function execFileMaker(data, scriptName) {
        if (typeof FileMaker !== 'undefined') {
          FileMaker.PerformScript(scriptName, JSON.stringify(data));
        } else {
          alert('FileMaker no definido');
        }
      }

      /*--- addressUtils.js---*/
      /**
       * Finds the long name of a specific address component from a Google Places API result.
       * @param { {
       * long_name: string,
       * short_name: string,
       * types: string[]
       * }[] } components - The array of address components from the API.
       * @param {string[]} types - An array of component types to search for (e.g., ['locality', 'political']).
       * @returns {string} The long name of the first matching component, or an empty string if not found.
       */
      const getComponent = (components, types) => {
        const found = components?.find((comp) =>
          types.every((type) => comp.types.includes(type))
        );
        return found?.long_name || found?.longText || '';
      };

      /**
       * Specifically extracts the 'delegacion' (borough) from the adrAddress format. (In addressComponents doesn't exist this component, so we need to extract it from the adrAddress string)
       * @param {string} adrAddress - Google Places API adrAddress format
       * @returns {string} The delegacion name or empty string if not found
       */
      const getDelegacion = (adrAddress) => {
        try {
          const matches = [...(adrAddress?.matchAll(/<span class="region">(.*?)<\/span>/g) || [])];
          return matches.length === 2 ? matches[0][1].trim() : '';
        } catch {
          return '';
        }
      };

      /**
       * Constructs a street address line from the route and street number components.
       * @param { {
       * long_name: string,
       * short_name: string,
       * types: string[]
       * }[] } components - The array of address components from the API [route, street_number]
       * @returns {string} Formatted street address line
       */
      const buildAddressLine = (components) => {
        const street = getComponent(components, ['route']);
        const number = getComponent(components, ['street_number']);
        return `${street} ${number}`.trim();
      };

      /* --- formatComments.js---*/
      /**
       * Formats additional place details into a comments string.
       * @param {object} details - Google Places API Place Details result
       * @param {string} details.internationalPhoneNumber - International phone number
       * @param {string} details.nationalPhoneNumber - National phone number
       * @param {string} details.website - Website URL
       * @returns {string} - Formatted comments string with available details or empty string if none are available
       */
      function formatComments(details) {
        const infoLines = [
          details.internationalPhoneNumber && `Teléfono internacional: ${details.internationalPhoneNumber}`,
          details.nationalPhoneNumber && `Teléfono nacional: ${details.nationalPhoneNumber}`,
          details.websiteURI && `Sitio web: ${details.websiteURI}`,
        ].filter(Boolean);
        if (infoLines.length === 0) {
          return '';
        }
        return `Datos adicionales del lugar:\r\n ${infoLines.join('\r\n ')}`;
      }

      /* --- formatTittle.js---*/
      /**
       * Format the title to include a line break if it exceeds maxLength.
       *
       * @param {string} title - the title to format
       * @param {number} maxLength - number of characters before inserting a line break
       * @returns {string} Formatted title with <br> if needed
       */
      function formatTitleWithWrap(title, maxLength) {
        if (title.length <= maxLength) {
          return title;
        }
        const breakIndex = title.indexOf(' ', maxLength);
        if (breakIndex === -1) {
          return title;
        }
        const firstLine = title.slice(0, breakIndex);
        const secondLine = title.slice(breakIndex + 1);
        return `${firstLine}<br>${secondLine}`;
      }

      /**
       * Formats a line of information for display in the info window.
       * @param {string} text - Text with information to display
       * @param {number} fontSize - Font size in px (default 14px)
       * @param {string} fontWeight - Font weight (normal, bold, lighter, semibold) (default normal)
       * @returns {string} - HTML string for the info line
       */
      const createInfoLine = (text, fontSize, fontWeight) => {
        if (!text) return '';
        return (
          `<div style="display: flex; align-items: start; margin-bottom: 1px; font-size: ${fontSize || '14px'}; font-weight: ${fontWeight || 'normal'};"> <span style="line-height: 1.4;">${text}</span> </div>`
        );
      };

      /**
       * Loads the Google Maps and Places libraries. (in this version only places are used, but maps will be used in future versions to draw routes and update API)
       * @returns {Promise<{Map: typeof google.maps.Map, Place: typeof google.maps.places.Place}>}
       */
      async function loadGoogleMaps() {
        const [{ Map }, { Place }] = await Promise.all([
          google.maps.importLibrary('maps'),
          google.maps.importLibrary('places'),
        ]);
        return { Map, Place };
      }

      /**
       * Initializes the map, marker, and place picker, and sets up event listeners.
       * @returns {Promise<void>}
       */
      async function init() {
        try {
          const { Place } = await loadGoogleMaps();
          await customElements.whenDefined('gmp-map');
          const map = document.querySelector('gmp-map');
          const marker = document.querySelector('gmp-advanced-marker');
          const placePicker = document.querySelector('gmpx-place-picker');
          const infowindow = new google.maps.InfoWindow();
          if ((coordinates && coordinates.lat && coordinates.lng) || (datos.placeDisplayName && datos.placeDisplayName !== '')) {
            coordinates = coordinates && coordinates.lat && coordinates.lng ? coordinates : { lat: 19.4326, lng: -99.1332 };
            marker.position = coordinates;
            map.center = coordinates;
            map.zoom = 17;
            let content = ` <div style="font-size: 14px; max-width: 320px; min-width: 250px;"> <div style="font-size: 17px; font-weight: bold; margin-bottom: 6px;">${formatTitleWithWrap(datos.placeDisplayName, 12)}</div> <hr style="margin: 6px 0; border: 0; border-top: 1px solid #777777ff;"> ${createInfoLine(datos.direccion1, '13px', 'bold')} ${createInfoLine([datos.colonia, datos.delegacion].filter(Boolean).join(', '), '12px')} ${createInfoLine([datos.ciudad, datos.estado, datos.cp].filter(Boolean).join(', '), '12px', 'semibold')} ${createInfoLine(datos.pais, '12px', 'lighter')} </div> <style> .gm-ui-hover-effect { position: absolute !important; width: 30px !important; height: 31px !important; top: 6px !important; right: 20px !important; } </style> `;
            infowindow.setContent(content);
            infowindow.open(map.innerMap, marker);
          }
          placePicker.addEventListener('gmpx-placechange', async () => {
            try {
              const place = placePicker.value;
              if (!place) return;
              if (place.viewport) {
                map.innerMap.fitBounds(place.viewport);
              } else {
                map.center = place.location;
                map.zoom = 17;
              }
              marker.position = place.location;
              const placeData = new Place({ id: place.id });
              await placeData.fetchFields({ fields: ['addressComponents', 'adrFormatAddress', 'formattedAddress', 'internationalPhoneNumber', 'nationalPhoneNumber', 'websiteURI'], });
              const details = {
                internationalPhoneNumber: placeData.internationalPhoneNumber || '',
                nationalPhoneNumber: placeData.nationalPhoneNumber || '',
                websiteURI: placeData.websiteURI || '',
              };
              datos = {
                id: place.id,
                placeDisplayName: place.displayName || '',
                direccion1: buildAddressLine(placeData.addressComponents),
                colonia: getComponent(placeData.addressComponents, ['neighborhood', 'political']) || getComponent(placeData.addressComponents, ['sublocality', 'political']),
                delegacion: getDelegacion(placeData.adrFormatAddress),
                cp: getComponent(placeData.addressComponents, ['postal_code']),
                ciudad: getComponent(placeData.addressComponents, ['locality', 'political']),
                estado: getComponent(placeData.addressComponents, ['administrative_area_level_1', 'political']),
                pais: getComponent(placeData.addressComponents, ['country', 'political']),
                coordenadas: place.location,
                direccionCompleta: placeData.formattedAddress,
                comments: formatComments(details),
                userIDU: 'Luis99',
                tenentIDU: '',
              };
              /*--- execFileMaker.js ---*/
              execFileMaker(datos, 'api.googleMaps ## drawMapAndSetCLs[js]^|v0.25.2');
            } catch (error) {
              console.error('Error en placechange:', error);
            }
          });
        } catch (error) {
          console.error('Error en inicialización:', error);
        }
      }
      document.addEventListener('DOMContentLoaded', init);
    </script>
  </head>
  <body>
    <gmpx-api-loader
      key="AIzaSyBoyn6j2iBSYnjo9SS5PnCP_zMuz-ME1_8"
      solution-channel="GMP_GE_mapsandplacesautocomplete_v2"
    >
    </gmpx-api-loader>
    <gmp-map center="19.4326,-99.1332" zoom="13" map-id="DEMO_MAP_ID">
      <div slot="control-block-start-inline-start">
        <gmpx-place-picker
          placeholder="Buscar dirección..."
        ></gmpx-place-picker>
      </div>
      <gmp-advanced-marker></gmp-advanced-marker>
    </gmp-map>
  </body>
</html>
